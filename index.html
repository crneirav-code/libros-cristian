<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Cristian Neira V. — Autor, estratega y filósofo del poder moderno.">
  <title>Cristian Neira V. — Autor</title>

  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
/* ====- MODAL DETALLE LIBRO (móvil, botones centrados) ==== */
.modal-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.45);
  display:none; align-items:center; justify-content:center; z-index:9999;
}
.modal-overlay.active{ display:flex; }

.modal{
  background:#fffdf9; color:#2c2c2c; border-radius:14px;
  max-width:900px; width:92%;
  max-height:calc(100dvh - 24px);        /* altura real del viewport */
  overflow:auto;                         /* scroll interno si hace falta */
  box-shadow:0 20px 60px rgba(0,0,0,.25);
  display:grid; grid-template-columns:320px 1fr;
}
.modal-header{
  grid-column:1 / -1; display:flex; justify-content:space-between; align-items:center;
  padding:14px 18px; background:#f4ede6; border-bottom:1px solid #eadfce;
}
.modal-header h3{ margin:0; font-size:1.2rem; color:#5a3b1c; }
.modal-close{ background:transparent; border:none; font-size:1.6rem; cursor:pointer; color:#7a4c29; }

.modal-left{ padding:18px; display:flex; align-items:flex-start; justify-content:center; background:#fffaf3; }
.modal-left img{ width:100%; max-width:280px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.1); }

.modal-right{ padding:18px 22px 28px; }   /* más aire abajo */
.modal-right .desc{ margin:8px 0 16px; color:#3e2c1e; line-height:1.55; text-align:left; }
.modal-meta{ font-size:.92rem; color:#7a5b42; margin-bottom:14px; text-align:left; }

.modal-actions{
  display:flex; gap:12px; flex-wrap:wrap; margin-top:14px;
  justify-content:center;                 /* centra los botones */
  padding-bottom:max(16px, env(safe-area-inset-bottom)); /* no se cortan abajo */
}
.btn-outline{
  background:transparent; border:1px solid #7a4c29; color:#7a4c29;
  padding:10px 16px; border-radius:6px; text-decoration:none; display:inline-block;
}
.btn-outline:hover{ background:#7a4c29; color:#fff; }

/* ===== MÓVIL ===== */
@media (max-width: 820px){
  .modal{
    grid-template-columns:1fr;
    width:100svw; height:100dvh; max-width:none; max-height:100dvh; border-radius:0;
  }
  .modal-header{
    position:sticky; top:0; z-index:1;       /* X siempre visible */
    padding-left:max(18px, env(safe-area-inset-left));
    padding-right:max(18px, env(safe-area-inset-right));
  }
  .modal-left{ justify-content:center; }
  .modal-left img{ max-height:48vh; object-fit:contain; }
  .modal-right, .modal-right .desc, .modal-meta{ text-align:center; }
}

/* En pantallas muy angostas apilamos botones, centrados y del mismo ancho */
@media (max-width: 480px){
  .modal-actions{ flex-direction:column; align-items:center; }
  .modal-actions .btn, .modal-actions .btn-outline{
    width:min(420px, 92%); text-align:center;
  }
}

    
    /* === GALERÍA AMAZON (sin iframe) === */
.book-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:36px 24px;       /* más separación vertical y horizontal */
  align-items:stretch;
  margin-top:30px;
  margin-bottom:50px;  /* separación antes del botón inferior */
}

.center-btn{
  text-align:center;
  margin-top:40px;     /* separa aún más del grid */
}


.book-card{
  background:#fff;
  border-radius:12px;
  padding:16px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
  transition:transform .2s ease, box-shadow .2s ease;
  display:flex;              /* clave: flex para igualar alturas */
  flex-direction:column;     /* imagen -> título -> botón */
  height:100%;
}

.book-card:hover{ transform:translateY(-4px); box-shadow:0 6px 18px rgba(0,0,0,.10); }

/* Contenedor de portada con altura fija responsive */
.book-cover{
  display:flex; align-items:center; justify-content:center;
  height:260px;               /* igual para todas las tarjetas */
}
.book-cover img{
  max-height:100%; max-width:100%; width:auto; border-radius:8px; display:block;
}

/* Bloque de título con altura mínima uniforme */
.book-title{
  margin:12px 0;
  font-family:Arial, sans-serif; font-size:.95rem; color:#5a3b1c;
  text-align:center;
  min-height:48px;            /* asegura misma altura de texto */
  display:flex; align-items:center; justify-content:center;
}

/* Botón abajo, siempre alineado */
.book-actions{ margin-top:auto; text-align:center; }
.btn{
  background:#7a4c29; color:#fff; padding:10px 16px; border-radius:6px;
  display:inline-block; text-decoration:none; font-family:Arial, sans-serif; font-size:.95rem;
}
.btn:hover{ background:#8f5a34; }
.btn:focus{ outline:2px solid #c9a78d; outline-offset:2px; }

/* Responsivo: portadas un poco más bajas en móviles */
@media (max-width: 700px){
  .book-cover{ height:220px; }
}
@media (max-width: 420px){
  .book-grid{ grid-template-columns:repeat(2, 1fr); }
  .book-cover{ height:200px; }
}


    /* === ESTILO GENERAL === */
    body {
      margin: 0;
      font-family: 'Georgia', serif;
      background-color: #f8f5f1;
      color: #2c2c2c;
      line-height: 1.6;
    }

    a { color: #7a4c29; text-decoration: none; }
    a:hover { color: #b26e41; }

    section { padding: 60px 20px; max-width: 1000px; margin: 0 auto; }

    /* === HEADER === */
    header {
      position: sticky;
      top: 0;
      background-color: rgba(248,245,241,0.98);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 40px;
      border-bottom: 1px solid #e0d8cf;
      z-index: 100;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: 1.6em;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    nav a {
      margin: 0 10px;
      font-weight: 500;
      font-family: 'Arial', sans-serif;
    }

    .social a {
      margin-left: 12px;
      font-size: 1.3em;
      color: #7a4c29;
    }

    /* === SECCIONES === */
    #amazon iframe {
      width: 100%;
      height: 1200px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      font-size: 1.8em;
      margin-bottom: 30px;
      color: #5a3b1c;
    }

    .bio, .noticias, .contacto {
      background-color: #fffdf9;
      border-radius: 10px;
      padding: 40px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-top: 30px;
    }

    .contacto p, .noticias p { text-align: center; }

    footer {
      background: #eae4dc;
      text-align: center;
      padding: 20px;
      font-size: 0.9em;
      color: #4a3b2a;
    }

    /* === RESPONSIVE === */
    @media (max-width: 700px) {
      header {
        flex-direction: column;
        text-align: center;
        gap: 8px;
      }
      nav { margin-top: 6px; }
    }
    /* ==== MODAL DETALLE LIBRO ==== */
.modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:999; }
.modal-overlay.active{ display:flex; }
.modal{ background:#fffdf9; color:#2c2c2c; border-radius:14px; max-width:900px; width:92%; box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden; display:grid; grid-template-columns:320px 1fr; }
.modal-header{ grid-column:1 / -1; display:flex; justify-content:space-between; align-items:center; padding:14px 18px; background:#f4ede6; border-bottom:1px solid #eadfce; }
.modal-header h3{ margin:0; font-size:1.2rem; color:#5a3b1c; }
.modal-close{ background:transparent; border:none; font-size:1.4rem; cursor:pointer; color:#7a4c29; }
.modal-left{ padding:18px; display:flex; align-items:flex-start; justify-content:center; background:#fffaf3; }
.modal-left img{ width:100%; max-width:280px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.1); }
.modal-right{ padding:18px 22px; }
.modal-right .desc{ margin:8px 0 16px; color:#3e2c1e; line-height:1.55; }
.modal-meta{ font-size:.92rem; color:#7a5b42; margin-bottom:14px; }
.modal-actions{ display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
.btn-outline{ background:transparent; border:1px solid #7a4c29; color:#7a4c29; padding:10px 16px; border-radius:6px; text-decoration:none; display:inline-block; }
.btn-outline:hover{ background:#7a4c29; color:#fff; }
@media (max-width:820px){ .modal{ grid-template-columns:1fr; } .modal-left{ justify-content:center; } }

    /* === SOBRE EL AUTOR (centrado y responsivo) === */
#sobre { padding-top: 70px; padding-bottom: 60px; }
#sobre h2 { text-align:center; margin-bottom: 26px; }

#sobre .bio{
  max-width: 760px;           /* controla el ancho de lectura */
  margin: 0 auto;             /* centra el bloque */
  text-align: center;         /* centra el texto */
  background: #fffdf9;
  border-radius: 12px;
  padding: clamp(20px, 4vw, 36px);
  box-shadow: 0 2px 10px rgba(0,0,0,.05);
}

#sobre .bio p{
  margin: 0;
  font-size: clamp(1rem, 2.2vw, 1.08rem);
  line-height: 1.7;
  color: #3a2b1e;
}

#sobre .bio b{
  color: #5a3b1c;
  font-weight: 700;
}
/* Botones extra y fila de compartir */
.modal-cta, .modal-share{ margin-top:16px; display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
.btn-ghost{ background:transparent; border:1px dashed #b28b6b; color:#7a4c29; padding:10px 16px; border-radius:6px; text-decoration:none; }
.btn-ghost:hover{ background:#f4ede6; }
.share-btn{
  display:inline-flex; align-items:center; gap:8px;
  background:#fff; border:1px solid #e6d8ca; padding:8px 12px; border-radius:8px; cursor:pointer;
  color:#5a3b1c; text-decoration:none;
}
.share-btn:hover{ background:#f6efe7; }
.modal-share small{ align-self:center; color:#7a5b42; margin-right:4px; }

    /* === INTERACCIÓN: like, rating y compartir === */
.like-wrap{ display:flex; gap:14px; align-items:center; justify-content:center; flex-wrap:wrap; }
.like-btn{
  display:inline-flex; align-items:center; gap:8px; cursor:pointer;
  background:#fff; border:1px solid #e6d8ca; padding:8px 12px; border-radius:8px; 
  color:#5a3b1c; font-family:Arial, sans-serif;
}
.like-btn:hover{ background:#f6efe7; }
.like-btn.liked i{ color:#c25555; }
.like-count{ font-weight:600; }

.rating{ display:inline-flex; align-items:center; gap:6px; }
.star{
  font-size:1.28rem; line-height:1; cursor:pointer; border:none; background:transparent;
  color:#c9a78d; padding:2px;
}
.star.active{ color:#f0b400; } /* estrellas encendidas */

.modal-share{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
.modal-share small{ align-self:center; color:#7a5b42; margin-right:4px; }
.share-btn{
  display:inline-flex; align-items:center; gap:8px;
  background:#fff; border:1px solid #e6d8ca; padding:8px 12px; border-radius:8px; cursor:pointer;
  color:#5a3b1c; text-decoration:none; font-family:Arial, sans-serif;
}
.share-btn:hover{ background:#f6efe7; }

    
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <h1>Cristian Neira V.</h1>
    <nav>
      <a href="#amazon">Libros</a>
      <a href="#sobre">Sobre el autor</a>
      <a href="#contacto">Contacto</a>
    </nav>
    <div class="social">
      <a href="https://www.linkedin.com/in/cristian-neirav/" target="_blank"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.instagram.com/cneira_escritor" target="_blank"><i class="fab fa-instagram"></i></a>
      <a href="https://www.amazon.com/stores/author/B0CVNMLSNZ" target="_blank"><i class="fab fa-amazon"></i></a>
    </div>
  </header>

  <!-- AMAZON -->
<section id="amazon">
  <h2>Libros</h2>

  <div class="book-grid">
   <!-- Manual de Succión Ejecutiva -->
<div class="book-card">
  <a class="book-cover" href="https://www.amazon.com/dp/B0FTTBJKBG" target="_blank" rel="noopener">
    <img src="covers/manual-de-succion-ejecutiva.jpg" alt="Manual de Succión Ejecutiva">
  </a>
  <div class="book-title">Manual de Succión Ejecutiva</div>
  <div class="book-actions">
    <button
      class="btn js-detail"
      data-title="Manual de Succión Ejecutiva"
      data-img="covers/manual-de-succion-ejecutiva.jpg"
      data-url="https://www.amazon.com/dp/B0FTTBJKBG"
      data-sample="https://read.amazon.com/kp/embed?asin=B0FTTBJKBG&preview=newtab&linkCode=kpe"
      data-meta="Edición Kindle, tapa blanda y tapa dura"
      data-desc="Sátira incisiva sobre el crecimiento profesional en la empresa real, un manual de sobrevivencia">
      Ver detalle
    </button>
  </div>
</div>

 <!-- Cosecha de Emociones: La Energía Secreta -->
<div class="book-card">
  <a class="book-cover" href="https://www.amazon.com/dp/B0CVNJLV1F" target="_blank" rel="noopener">
    <img src="covers/cosecha-de-emociones.jpg" alt="Cosecha de Emociones: La Energía Secreta">
  </a>
  <div class="book-title">Cosecha de Emociones: La Energía Secreta</div>
  <div class="book-actions">
    <button
      class="btn js-detail"
      data-title="Cosecha de Emociones: La Energía Secreta"
      data-img="covers/cosecha-de-emociones.jpg"
      data-url="https://www.amazon.com/dp/B0CVNJLV1F"
      data-sample="https://read.amazon.com/kp/embed?asin=B0CVNJLV1F&preview=newtab&linkCode=kpe"
      data-meta="Edición Kindle y tapa blanda"
      data-desc="Thriller de ciencia ficción donde una entidad ancestral consume la energía emocional humana.">
      Ver detalle
    </button>
  </div>
</div>

    <!-- El Último Líder Humano -->
    <div class="book-card">
      <a class="book-cover" href="https://www.amazon.com/dp/B0D1Z96H1V" target="_blank" rel="noopener">
        <img src="covers/ultimo-lider-humano.jpg" alt="El Último Líder Humano">
      </a>
      <div class="book-title">El Último Líder Humano</div>
      <div class="book-actions">
<button
  class="btn js-detail"
  data-title="El Último Líder Humano"
  data-img="covers/ultimo-lider-humano.jpg"
  data-url="https://www.amazon.com/dp/B0DJCP9TX8"
  data-sample="https://read.amazon.com/kp/embed?asin=B0DJCP9TX8&preview=newtab&linkCode=kpe"
  data-meta="Edición Kindle"
  data-desc="Ensayo provocador sobre el liderazgo en la era de la IA y los equipos aumentados.">
  Ver detalle
</button>

      </div>
    </div>

    <!-- Narrativas Cuánticas -->
<!-- Narrativas Cuánticas -->
<div class="book-card">
  <a class="book-cover" href="https://www.amazon.com/dp/B0D9DNNSFK" target="_blank" rel="noopener">
    <img src="covers/narrativas-cuanticas.jpg" alt="Narrativas Cuánticas: Reescribiendo tu Realidad">
  </a>
  <div class="book-title">Narrativas Cuánticas</div>
  <div class="book-actions">
    <button
      class="btn js-detail"
      data-title="Narrativas Cuánticas"
      data-img="covers/narrativas-cuanticas.jpg"
      data-url="https://www.amazon.com/dp/B0D9DNNSFK"
      data-sample="https://read.amazon.com/kp/embed?asin=B0D9DNNSFK&preview=newtab&linkCode=kpe"
      data-meta="Edición Kindle y tapa blanda""
      data-desc="Cómo reescribir tu realidad integrando ciencia, psicología y narrativa personal.">
      Ver detalle
    </button>
  </div>
</div>


    <!-- Convergencia Digital -->
    <div class="book-card">
      <a class="book-cover" href="https://www.amazon.com/s?k=Convergencia+Digital+Cristian+Neira" target="_blank" rel="noopener">
        <img src="covers/convergencia-digital.jpg" alt="Convergencia Digital: Mentes y Mercado">
      </a>
      <div class="book-title">Convergencia Digital</div>
      <div class="book-actions">
        <button
          class="btn js-detail"
          data-title="Convergencia Digital: Mentes y Mercado"
          data-img="covers/convergencia-digital.jpg"
          data-url="https://a.co/d/8GCDqsy"
          data-sample="https://www.amazon.com/s?k=Convergencia+Digital+Cristian+Neira"
          data-meta="Edición Kindle y tapa blanda"
          data-desc="Estrategia digital, comportamiento del consumidor y captura de valor en mercados hiperconectados.">
          Ver detalle
        </button>
      </div>
    </div>

    <!-- El Tablero Invisible -->
    <div class="book-card">
      <a class="book-cover" href="https://www.amazon.com/s?k=El+Tablero+Invisible+Cristian+Neira" target="_blank" rel="noopener">
        <img src="covers/tablero-invisible.jpg" alt="El Tablero Invisible">
      </a>
      <div class="book-title">El Tablero Invisible</div>
      <div class="book-actions">
        <button
          class="btn js-detail"
          data-title="El Tablero Invisible"
          data-img="covers/tablero-invisible.jpg"
          data-url="https://www.cneirav.cl"
          data-sample="https://www.cneirav.cl"
          data-meta="Disponible próximamente"
          data-desc="Manual de supervivencia para navegar el poder oculto y los fractales políticos de las organizaciones.">
          Ver detalle
        </button>
      </div>
    </div>
  </div>

  <p class="center-btn">
    <a class="btn" href="https://www.amazon.com/stores/author/B0CVNMLSNZ/allbooks" target="_blank" rel="noopener">
      Ver todos en Amazon
    </a>
  </p>
</section>

  <!-- SOBRE EL AUTOR -->
  <section id="sobre">
  <h2>Sobre el Autor</h2>
  <div class="bio">
    <p><b>Cristian Neira V.</b> es estratega, investigador y autor chileno con más de dos décadas de experiencia en el mundo corporativo y académico. Su obra literaria combina filosofía, psicología, sociología y tecnología para explorar los dilemas del poder, el liderazgo y la transformación digital. Con un estilo provocador e irónico, escribe tanto ensayo como narrativa, moviéndose entre la crítica corporativa, la ficción especulativa y la reflexión sobre el futuro del trabajo y la sociedad.</p>
  </div>
</section>

  <!-- CONTACTO -->
  <section id="contacto">
    <h2>Contacto</h2>
    <div class="contacto">
      <p>📧 Escríbele a: <a href="mailto:contacto@cneirav.cl">contacto@cneirav.cl</a></p>
      <p>🌐 Síguelo en redes sociales:  
        <a href="https://www.linkedin.com/in/cristian-neirav" target="_blank">LinkedIn</a> · 
        <a href="https://www.instagram.com/cneira_escritor" target="_blank">Instagram</a> · 
        <a href="https://www.amazon.com/stores/author/B0CVNMLSNZ" target="_blank">Amazon</a>
      </p>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    © 2025 Cristian Neira V. — Todos los derechos reservados.
  </footer>
   <!-- MODAL: colócalo ANTES del script y DENTRO del body -->
  <div class="modal-overlay" id="bookModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h3 id="modalTitle">Título del libro</h3>
        <button class="modal-close" aria-label="Cerrar" id="modalClose">&times;</button>
      </div>

      <div class="modal-left">
        <img id="modalImg" src="" alt="">
      </div>

      <div class="modal-right">
        <div class="modal-meta" id="modalMeta"></div>
        <p class="desc" id="modalDesc"></p>

        <div class="modal-actions">
          <a id="modalSample" class="btn-outline" target="_blank" rel="noopener">Leer muestra</a>
          <a id="modalAmazon" class="btn" target="_blank" rel="noopener">Comprar</a>
        </div>
        <!-- INTERACCIÓN: Me gusta + Valoración -->
<div class="like-wrap" style="margin-top:12px;">
  <!-- DATOS REALES -->
<div id="realStats" style="text-align:center; margin-top:6px; color:#5a3b1c; font-family:Arial, sans-serif; font-size:0.9rem;">
  <span id="realLikes">❤️ 0 Me gusta</span> &nbsp;|&nbsp;
  <span id="realRating">⭐ Promedio: 0.0</span>
</div>

  <button id="likeBtn" class="like-btn" type="button" aria-label="Me gusta">
    <i class="fa-regular fa-heart"></i>
    <span id="likeText">Me gusta</span>
    <span class="like-count" id="likeCount">0</span>
  </button>

  <div class="rating" aria-label="Valorar este libro">
    <button class="star" data-score="1" aria-label="1 estrella">&#9733;</button>
    <button class="star" data-score="2" aria-label="2 estrellas">&#9733;</button>
    <button class="star" data-score="3" aria-label="3 estrellas">&#9733;</button>
    <button class="star" data-score="4" aria-label="4 estrellas">&#9733;</button>
    <button class="star" data-score="5" aria-label="5 estrellas">&#9733;</button>
  </div>
</div>

<!-- COMPARTIR -->
<div class="modal-share">
  <small>Compartir:</small>
  <a id="shareNative"   class="share-btn"><i class="fa fa-share-alt"></i> Sistema</a>
  <a id="shareWhatsapp" class="share-btn" target="_blank" rel="noopener"><i class="fab fa-whatsapp"></i> WhatsApp</a>
  <a id="shareLinkedin" class="share-btn" target="_blank" rel="noopener"><i class="fab fa-linkedin"></i> LinkedIn</a>
  <a id="shareX"        class="share-btn" target="_blank" rel="noopener"><i class="fab fa-x-twitter"></i> X</a>
  <a id="shareCopy"     class="share-btn"><i class="fa fa-link"></i> Copiar enlace</a>
</div>

      </div>
    </div>
  </div>

  // === Config global (arriba del script) ===
const WORKER_URL = 'https://interacciones-libros.modomayorcl.workers.dev';

// Slug desde el título (coincide con el JSON)
function slugFromTitle(title){
  return (title || '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '_')
    .replace(/^_+|_+$/g, '');
}

  
  <script>
(function(){
  const qs = s => document.querySelector(s);
  const qid = id => document.getElementById(id);

  const overlay = qid('bookModal');
  const modalImg = qid('modalImg');
  const modalTitle = qid('modalTitle');
  const modalMeta = qid('modalMeta');
  const modalDesc = qid('modalDesc');
  const modalAmazon = qid('modalAmazon');
  const modalSample = qid('modalSample');
  const closeBtn = qid('modalClose');

    // --- NUEVOS ELEMENTOS DE INTERACCIÓN ---
  const likeBtn   = document.getElementById('likeBtn');
  const likeCount = document.getElementById('likeCount');
  const likeText  = document.getElementById('likeText');
  const starNodes = () => Array.from(document.querySelectorAll('.modal-right .star')); // función por si re-render

  // Opcionales (pueden no existir)
  const followAmazon = qid('modalFollowAmazon');
  const shareNative = qid('shareNative');
  const shareWhatsapp = qid('shareWhatsapp');
  const shareX = qid('shareX');
  const shareLinkedin = qid('shareLinkedin');
  const shareCopy = qid('shareCopy');

  const AUTHOR_PAGE = "https://www.amazon.com/stores/author/B0CVNMLSNZ";

  let modalOpen = false;
  let pushedState = false;
  let currentShare = { title: '', url: '' };

  function lockScroll(lock){
    document.documentElement.style.overflow = lock ? 'hidden' : '';
    document.body.style.overflow = lock ? 'hidden' : '';
    document.body.style.touchAction = lock ? 'none' : '';
  }
  // Normaliza clave por título
  function keyFor(title){
    return 'book_' + (title || '').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
  }

  function loadState(k){
    return {
      likes : parseInt(localStorage.getItem(k + '_likes')  || '0', 10),
      liked : localStorage.getItem(k + '_liked') === '1',
      stars : parseInt(localStorage.getItem(k + '_rating') || '0', 10)
    };
  }

  function saveLikes(k, likes){ localStorage.setItem(k + '_likes', String(likes)); }
  function saveLiked(k, liked){ localStorage.setItem(k + '_liked', liked ? '1' : '0'); }
  function saveStars(k, stars){ localStorage.setItem(k + '_rating', String(stars)); }

  function paintStars(n){
    starNodes().forEach(st => {
      const s = parseInt(st.dataset.score, 10);
      st.classList.toggle('active', s <= n);
    });
  }

  // Convierte el título del libro en un "slug" compatible con el JSON
function slugFromTitle(title){
  return (title || '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '_')   // reemplaza espacios y signos por _
    .replace(/^_+|_+$/g, '');       // elimina _ iniciales o finales
}
  // === UTIL: convierte el título en un slug compatible con el JSON (usa _)
function slugFromTitle(title){
  return (title || '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '_')
    .replace(/^_+|_+$/g, '');
}

// (si no lo tienes aún) URL del Worker
const WORKER_URL = 'https://interacciones-libros.modomayorcl.workers.dev';
  function openModal(data){
  function openModal(data){
  // 1) slug para este libro
  const BOOK_SLUG = slugFromTitle(data.title || 'libro');

  // 2) función para leer stats reales (defínela ANTES de usarla en handlers)
  async function fetchStatsReal(){
    try{
      const r = await fetch(`${WORKER_URL}/stats?book=${encodeURIComponent(BOOK_SLUG)}`);
      const s = await r.json();
      const likes = s.likes ?? 0;
      const avg   = s.rating_count ? (s.rating_sum / s.rating_count) : 0;

      const likesEl  = document.getElementById('realLikes');
      const ratingEl = document.getElementById('realRating');
      if(likesEl)  likesEl.textContent  = `❤️ ${likes} Me gusta`;
      if(ratingEl) ratingEl.textContent = `⭐ Promedio: ${avg.toFixed(1)}`;

      if (typeof likeCount !== 'undefined' && likeCount) likeCount.textContent = String(likes);
      if (typeof paintStars === 'function') paintStars(Math.round(avg));
    }catch(e){ console.warn('No se pudo cargar stats reales', e); }
  }

    if (!overlay) return; // si falta el modal, salimos silenciosamente

    modalTitle && (modalTitle.textContent = data.title || '');
    if (modalImg){
      modalImg.src = data.img || '';
      modalImg.alt = data.title || '';
    }
    modalMeta && (modalMeta.textContent = data.meta || '');
    modalDesc && (modalDesc.textContent = data.desc || '');

    if (modalAmazon) modalAmazon.href = data.url || '#';
    if (modalSample) modalSample.href = data.sample || data.url || '#';

// Cargar stats reales desde el Worker
async function fetchStatsReal(){
  try{
    const r = await fetch(`${WORKER_URL}/stats?book=${encodeURIComponent(BOOK_SLUG)}`);
    const s = await r.json();
    const likes = s.likes ?? 0;
    const avg   = s.rating_count ? (s.rating_sum / s.rating_count) : 0;

    const likesEl  = document.getElementById('realLikes');
    const ratingEl = document.getElementById('realRating');
    if(likesEl)  likesEl.textContent  = `❤️ ${likes} Me gusta`;
    if(ratingEl) ratingEl.textContent = `⭐ Promedio: ${avg.toFixed(1)}`;

    // si tienes contador visual y estrellas locales:
    if (typeof likeCount !== 'undefined' && likeCount) likeCount.textContent = String(likes);
    if (typeof paintStars === 'function') paintStars(Math.round(avg));
  } catch(e){ console.warn('No se pudo cargar stats reales', e); }
}
fetchStatsReal(); // dispara lectura al abrir el modal

    
    // --- ESTADO POR LIBRO ---
    const STORE_KEY = keyFor(data.title || 'libro');
    let state = loadState(STORE_KEY);

    // Inicializa UI de likes
    if (likeCount) likeCount.textContent = String(state.likes);
    if (likeBtn){
      likeBtn.classList.toggle('liked', state.liked);
      likeText && (likeText.textContent = state.liked ? 'Te gusta' : 'Me gusta');

     likeBtn.onclick = function(){
  state = loadState(STORE_KEY);

  // toggle local
  if (state.liked){
    state.liked = false;
    state.likes = Math.max(0, state.likes - 1);
  } else {
    state.liked = true;
    state.likes = state.likes + 1;
  }
  saveLiked(STORE_KEY, state.liked);
  saveLikes(STORE_KEY, state.likes);
  likeBtn.classList.toggle('liked', state.liked);
  if (likeCount) likeCount.textContent = String(state.likes);
  if (likeText)  likeText.textContent  = state.liked ? 'Te gusta' : 'Me gusta';

  // delta: +1 si quedó en "liked", -1 si se quitó
  const delta = state.liked ? +1 : -1;
  fetch(`${WORKER_URL}/event`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type: 'like', book: BOOK_SLUG, delta })
  })
  .then(() => setTimeout(fetchStatsReal, 800))
  .catch(()=>{});
};

    }

    // Inicializa UI de estrellas
    paintStars(state.stars);
    starNodes().forEach(st => {
  st.onclick = function(){
    const val = parseInt(this.dataset.score, 10) || 0;
    const previous = state.stars || 0; // valor anterior
    state.stars = val;

    // Guarda local/local UI
    saveStars(STORE_KEY, state.stars);
    paintStars(state.stars);

    // Enviar al backend (GitHub vía Worker)
    fetch(`${WORKER_URL}/event`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'rate',
        book: BOOK_SLUG,
        newRating: val,
        oldRating: previous
      })
    })
    .then(() => setTimeout(fetchStatsReal, 800))
    .catch(()=>{});
  };
});

  // Guarda localmente
  saveStars(STORE_KEY, state.stars);
  paintStars(state.stars);

  // 🔗 Envía al Worker (GitHub)
  fetch(`${WORKER_URL}/event`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      type: 'rate',
      book: BOOK_SLUG,
      newRating: val,
      oldRating: previous
    })
  })
  .then(() => setTimeout(fetchStatsReal, 800)) // refresca los datos reales
  .catch(()=>{});
};

    
    // CTA seguir autor (opcional)
    if (followAmazon) followAmazon.href = AUTHOR_PAGE;

    // Compartir (opcional)
    currentShare = { title: data.title || 'Libro', url: data.url || location.href };
    const t = encodeURIComponent(currentShare.title + ' — de Cristian Neira');
    const u = encodeURIComponent(currentShare.url);
    if (shareWhatsapp) shareWhatsapp.href = `https://wa.me/?text=${t}%20${u}`;
    if (shareX)        shareX.href        = `https://twitter.com/intent/tweet?text=${t}&url=${u}`;
    if (shareLinkedin) shareLinkedin.href = `https://www.linkedin.com/sharing/share-offsite/?url=${u}`;

    overlay.classList.add('active');
    overlay.setAttribute('aria-hidden', 'false');
    lockScroll(true);
    modalOpen = true;

    if (!pushedState) {
      history.pushState({ modal: true }, '');
      pushedState = true;
    }
    closeBtn && closeBtn.focus();
  }

  function reallyCloseModal(){
    if (!overlay) return;
    overlay.classList.remove('active');
    overlay.setAttribute('aria-hidden', 'true');
    lockScroll(false);
    modalOpen = false;
  }

  function closeModalFromUI(){
    if (pushedState) {
      pushedState = false;
      reallyCloseModal();
      if (history.state && history.state.modal) history.back();
      return;
    }
    reallyCloseModal();
  }

  // Abrir desde cualquier .js-detail
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.js-detail');
    if (btn) {
      e.preventDefault();
      openModal({
        title:  btn.dataset.title,
        img:    btn.dataset.img,
        url:    btn.dataset.url,
        sample: btn.dataset.sample,
        meta:   btn.dataset.meta,
        desc:   btn.dataset.desc
      });
    }
    if (e.target && (e.target.id === 'modalClose' || e.target === overlay)) {
      e.preventDefault();
      closeModalFromUI();
    }
  });
  // ...después de setear imagen, título y botones del modal:
  fetchStatsReal();

  // ESC
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && modalOpen) {
      e.preventDefault();
      closeModalFromUI();
    }
  });

  // Atrás en móvil
  window.addEventListener('popstate', function(){
    if (modalOpen) {
      pushedState = false;
      reallyCloseModal();
    }
  });

  // Compartir (opcionales)
  if (shareNative) {
    shareNative.addEventListener('click', async function(){
      try{
        if (navigator.share) {
          await navigator.share({ title: currentShare.title, url: currentShare.url });
        } else if (navigator.clipboard) {
          await navigator.clipboard.writeText(currentShare.url);
          shareNative.textContent = 'Enlace copiado';
          setTimeout(()=> shareNative.innerHTML = '<i class="fa fa-share-alt"></i> Sistema', 1400);
        }
      }catch(_){}
    });
  }
  if (shareCopy) {
    shareCopy.addEventListener('click', async function(){
      try{
        await navigator.clipboard.writeText(currentShare.url);
        shareCopy.textContent = 'Copiado ✔';
        setTimeout(()=> shareCopy.innerHTML = '<i class="fa fa-link"></i> Copiar enlace', 1400);
      }catch(_){}
    });
  }
})();
</script>
</body>

</html>
